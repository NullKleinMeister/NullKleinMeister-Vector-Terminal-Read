<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VECTOR READER v1.1 - GAP RESTORED</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body {
            background-color: #000;
            color: #228530;
            font-family: 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 60px;
            background: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        #viewer-container {
            /* 初始宽度 */
            width: 80%; 
            height: 90%; 
            position: relative;
            border: 4px solid #228530; 
            border-radius: 40px;
            padding: 20px;
            box-sizing: border-box;
            filter: url(#curve); 
            transform: scale(0.92);
            /* 添加过渡动画，让调整 GAP 时更平滑 */
            transition: width 0.3s ease;
            box-shadow: inset 0 0 60px rgba(34, 133, 48, 0.3);
            background: rgba(0, 15, 0, 0.5);
        }

        #viewer {
            width: 100%;
            height: 100%;
            text-shadow: 2px 0 rgba(255,0,0,0.4), -2px 0 rgba(0,0,255,0.4);
            filter: contrast(1.2) brightness(1.1) sepia(100%) hue-rotate(90deg);
        }

        .screen-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            background: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 70%),
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100%, 100% 4px;
            z-index: 10;
            box-shadow: inset 0 0 120px rgba(0,0,0,0.9);
        }

        .nav-zone {
            position: absolute;
            top: 0; bottom: 0; width: 15%;
            z-index: 20;
            cursor: pointer;
        }
        .nav-left { left: 0; }
        .nav-right { right: 0; }

        .controls {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: #000;
            border-top: 1px solid #228530;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 20px;
            z-index: 100;
        }

        button {
            background: #000; color: #228530; border: 1px solid #228530;
            padding: 4px 10px; cursor: pointer; font-family: inherit;
            font-size: 11px;
        }
        button:hover { background: #228530; color: #000; }
        #pos { font-size: 12px; min-width: 120px; text-align: center; }
    </style>
</head>
<body>

    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <filter id="curve">
                <feImage xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmFkaWFsR3JhZGllbnQgaWQ9ImciIHI9IjAuNyI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjODAwMDAwIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjMDAwMDAwIi8+PC9yYWRpYWxHcmFkaWVudD48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0idXJsKCNnKSIvPjwvc3ZnPg==" result="lens-map"/>
                <feDisplacementMap in="SourceGraphic" in2="lens-map" scale="40" xChannelSelector="R" yChannelSelector="R"/>
            </filter>
        </defs>
    </svg>

    <div class="screen">
        <div id="viewer-container">
            <div id="viewer"></div>
            <div class="nav-zone nav-left" onclick="prevPage()"></div>
            <div class="nav-zone nav-right" onclick="nextPage()"></div>
        </div>
        <div class="screen-overlay"></div>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" accept=".epub">
        <span id="pos">SECTOR READY</span>
        <div>
            <button onclick="prevPage()">PREV</button>
            <button onclick="nextPage()">NEXT</button>
            <span style="margin: 0 5px;">| SIZE</span>
            <button onclick="changeFontSize(2)">+</button>
            <button onclick="changeFontSize(-2)">-</button>
            <span style="margin: 0 5px;">| GAP</span>
            <button onclick="changeMargin(5)">+</button>
            <button onclick="changeMargin(-5)">-</button>
        </div>
    </div>

<script>
    var book;
    window.rendition = null;
    var currentFontSize = 18;
    var currentWidth = 80; 

    document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(event) {
            if (book) book.destroy();
            book = ePub(event.target.result);
            renderBook();
        };
        reader.readAsArrayBuffer(file);
    });

    function renderBook() {
        window.rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            flow: "paginated",
            manager: "default",
            allowScriptedContent: true
        });

        window.rendition.display().then(() => applyStyles());

        window.rendition.on("relocated", (loc) => {
            var percent = loc.start.percentage;
            document.getElementById('pos').innerText = "PROGRESS: " + Math.floor(percent * 100) + "%";
        });

        document.addEventListener("keyup", handleKey);
        window.rendition.on("keyup", handleKey);
    }

    function handleKey(e) {
        if (e.keyCode == 37) prevPage();
        if (e.keyCode == 39) nextPage();
    }

    function prevPage() { if (window.rendition) window.rendition.prev(); }
    function nextPage() { if (window.rendition) window.rendition.next(); }

    function applyStyles() {
        if (!window.rendition) return;
        window.rendition.themes.default({
            "body": {
                "color": "#228530 !important",
                "background": "transparent !important",
                "padding": "20px 40px !important"
            }
        });
        window.rendition.themes.fontSize(currentFontSize + "px");
    }

    function changeFontSize(delta) {
        currentFontSize += delta;
        if (window.rendition) window.rendition.themes.fontSize(currentFontSize + "px");
    }

    // GAP 功能回归
    function changeMargin(delta) {
        currentWidth -= delta; 
        if (currentWidth > 95) currentWidth = 95;
        if (currentWidth < 30) currentWidth = 30;
        var container = document.getElementById('viewer-container');
        container.style.width = currentWidth + "%";
        // 调整 container 大小后，必须通知 Epub.js 重新计算页面布局
        if (window.rendition) window.rendition.resize();
    }
</script>
</body>
</html>
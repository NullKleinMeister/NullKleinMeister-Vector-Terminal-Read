<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VECTOR READER v0.8 - PERFORMANCE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body {
            background-color: #000;
            color: #228530;
            font-family: 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 60px;
            background: #050505;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        #viewer-container {
            width: 80%; 
            height: 90%; 
            position: relative;
            border: 3px solid #228530; 
            border-radius: 20px;
            padding: 10px;
            box-sizing: border-box;
            
            /* 性能优化：降低滤镜比例，从 40 降到 25，依然有弯曲感但省电 */
            filter: url(#curve); 
            
            transform: scale(0.95);
            transition: width 0.3s ease;
            box-shadow: inset 0 0 40px rgba(34, 133, 48, 0.2);
            background: rgba(0, 20, 0, 0.3);
        }

        #viewer {
            width: 100%;
            height: 100%;
            /* 性能优化：稍微减弱色散阴影的模糊半径 */
            text-shadow: 1px 0 rgba(255,0,0,0.3), -1px 0 rgba(0,0,255,0.3);
            filter: contrast(1.2) brightness(1.2) sepia(100%) hue-rotate(90deg);
        }

        .screen-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            background: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.03) 0%, transparent 60%),
                linear-gradient(rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 100%, 100% 4px;
            z-index: 10;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        .nav-overlay {
            position: absolute;
            top: 0; bottom: 0; width: 15%;
            z-index: 20;
            cursor: pointer;
        }
        .nav-prev { left: 0; }
        .nav-next { right: 0; }

        .controls {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: #000;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 20px;
            z-index: 100;
        }

        button {
            background: #000; color: #228530; border: 1px solid #228530;
            padding: 4px 12px; cursor: pointer; font-family: inherit;
        }
        button:hover { background: #228530; color: #000; }
        #pos { color: #228530; font-size: 12px; min-width: 80px; text-align: center; }
    </style>
</head>
<body>

    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="curve">
                <feImage xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmFkaWFsR3JhZGllbnQgaWQ9ImciIHI9IjAuNyI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjODAwMDAwIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjMDAwMDAwIi8+PC9yYWRpYWxHcmFkaWVudD48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0idXJsKCNnKSIvPjwvc3ZnPg==" result="lens-map"/>
                <feDisplacementMap in="SourceGraphic" in2="lens-map" scale="25" xChannelSelector="R" yChannelSelector="R"/>
            </filter>
        </defs>
    </svg>

    <div class="screen">
        <div id="viewer-container">
            <div id="viewer"></div>
            <div class="nav-overlay nav-prev" onclick="prevPage()"></div>
            <div class="nav-overlay nav-next" onclick="nextPage()"></div>
        </div>
        <div class="screen-overlay"></div>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" accept=".epub" style="color:#228530;">
        <div>
            <button onclick="toggleFlow()">MODE: SWAP</button>
            <span id="pos">READY</span>
        </div>
        <div>
            <button onclick="prevPage()">PREV</button>
            <button onclick="nextPage()">NEXT</button>
            <span style="margin-left:10px;">SIZE</span>
            <button onclick="changeFontSize(2)">+</button>
            <button onclick="changeFontSize(-2)">-</button>
            <span style="margin-left:10px;">GAP</span>
            <button onclick="changeMargin(5)">+</button>
            <button onclick="changeMargin(-5)">-</button>
        </div>
    </div>

<script>
    var book;
    window.rendition = null;
    var currentFontSize = 18;
    var currentWidth = 80; 
    var isScrolled = true;

    document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(event) {
            if (book) book.destroy();
            book = ePub(event.target.result);
            renderBook();
        };
        reader.readAsArrayBuffer(file);
    });

    function renderBook() {
        window.rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            flow: isScrolled ? "scrolled" : "paginated",
            manager: isScrolled ? "continuous" : "default"
        });

        window.rendition.display().then(function() {
            applyStyles();
            document.getElementById('pos').innerText = "ONLINE";
        });

        window.rendition.on("relocated", function(location) {
            var percent = location.start.percentage;
            document.getElementById('pos').innerText = "POS: " + Math.floor(percent * 100) + "%";
        });

        // 绑定键盘
        window.rendition.on("keyup", handleKey);
        document.addEventListener("keyup", handleKey, false);
    }

    function handleKey(e) {
        if ((e.keyCode || e.which) == 37) prevPage();
        if ((e.keyCode || e.which) == 39) nextPage();
    }

    function prevPage() { if (window.rendition) window.rendition.prev(); }
    function nextPage() { if (window.rendition) window.rendition.next(); }

    function applyStyles() {
        if (!window.rendition) return;
        window.rendition.themes.default({
            "body": {
                "color": "#228530 !important",
                "background": "transparent !important",
                "padding": isScrolled ? "80px 0 !important" : "20px 40px !important"
            },
            "p": { "margin-bottom": "1.5em !important", "line-height": "1.6" }
        });
        window.rendition.themes.fontSize(currentFontSize + "px");
    }

    function toggleFlow() {
        isScrolled = !isScrolled;
        if (book) {
            var cfi = window.rendition.currentLocation().start.cfi;
            window.rendition.destroy();
            renderBook();
            window.rendition.display(cfi);
        }
    }

    function changeFontSize(delta) {
        currentFontSize += delta;
        if (window.rendition) window.rendition.themes.fontSize(currentFontSize + "px");
    }

    function changeMargin(delta) {
        currentWidth -= delta; 
        if (currentWidth > 95) currentWidth = 95;
        if (currentWidth < 30) currentWidth = 30;
        document.getElementById('viewer-container').style.width = currentWidth + "%";
        if (window.rendition) window.rendition.resize();
    }
</script>
</body>
</html>